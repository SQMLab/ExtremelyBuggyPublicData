{
    "origin": "codeshovel",
    "repositoryName": "pulsar",
    "repositoryPath": "/home/student/mortonss/research/better_bug_research/github_repos/pulsar/.git",
    "startCommitName": "HEAD",
    "sourceFileName": "OpAddEntry.java",
    "functionName": "failed",
    "functionId": "failed___e-ManagedLedgerException",
    "sourceFilePath": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
    "functionStartLine": 178,
    "functionEndLine": 189,
    "numCommitsSeen": 51,
    "timeTaken": 2138,
    "changeHistory": [
        "9f849c324969e160f9891203b2a2e4805fae5a1c",
        "f5ffbbe1ed2b79be1caf4a59688eab006e932ced",
        "358bbc20f151e2fb2f321ab42dce5f68b340bfd3",
        "48431543729fc4f382637c968976d0d164d5427b",
        "a704afd1946c5648f06b12031320359d5aef623d",
        "d72b986d311d8b528619f4a4dcddf757b3975dde",
        "60abcaa96508fcf9faeeeff30266ff82e9f51390",
        "6275297499874e980b4656694f5b90aa5cc23c18",
        "1bcbab04df4055714036afa3ce3bf6cf370869c9",
        "3e3622c1d4b8b9169b4ba69081a16a539606b72d",
        "03bbc8e67ad429a774936d26ab2f4d40c1ea4999",
        "16a30a7037836641bf9453c7d07b3b6aab80ec26"
    ],
    "changeHistoryShort": {
        "16a30a7037836641bf9453c7d07b3b6aab80ec26": "Ybodychange",
        "03bbc8e67ad429a774936d26ab2f4d40c1ea4999": "Ybodychange",
        "3e3622c1d4b8b9169b4ba69081a16a539606b72d": "Ybodychange",
        "1bcbab04df4055714036afa3ce3bf6cf370869c9": "Ybodychange",
        "6275297499874e980b4656694f5b90aa5cc23c18": "Ybodychange",
        "60abcaa96508fcf9faeeeff30266ff82e9f51390": "Ybodychange",
        "d72b986d311d8b528619f4a4dcddf757b3975dde": "Ybodychange",
        "a704afd1946c5648f06b12031320359d5aef623d": "Ybodychange",
        "48431543729fc4f382637c968976d0d164d5427b": "Ybodychange",
        "358bbc20f151e2fb2f321ab42dce5f68b340bfd3": "Ybodychange",
        "f5ffbbe1ed2b79be1caf4a59688eab006e932ced": "Ybodychange",
        "9f849c324969e160f9891203b2a2e4805fae5a1c": "Yintroduced"
    },
    "changeHistoryDetails": {
        "16a30a7037836641bf9453c7d07b3b6aab80ec26": {
            "type": "Ybodychange",
            "commitMessage": "[fix][broker] Fix index generator is not rollback after entries are failed added. (#19727)\n\nCo-authored-by: gavingaozhangmin <gavingaozhangmin@didiglobal.com>",
            "commitDate": "13/03/23 1:13 AM",
            "commitName": "16a30a7037836641bf9453c7d07b3b6aab80ec26",
            "commitAuthor": "Zhangao",
            "commitDateOld": "03/02/23 3:12 AM",
            "commitNameOld": "33f40f6154ad20ffadd954d2fbb9fd1ee4268efb",
            "commitAuthorOld": "fengyubiao",
            "daysBetweenCommits": 37.88,
            "commitsBetweenForRepo": 130,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,11 +1,12 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n+        ml.afterFailedAddEntry(this.getNumberOfMessages());\n         if (cb != null) {\n             ReferenceCountUtil.release(data);\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n             if (payloadProcessorHandle != null) {\n                 payloadProcessorHandle.release();\n             }\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        ml.afterFailedAddEntry(this.getNumberOfMessages());\n        if (cb != null) {\n            ReferenceCountUtil.release(data);\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n            if (payloadProcessorHandle != null) {\n                payloadProcessorHandle.release();\n            }\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {}
        },
        "03bbc8e67ad429a774936d26ab2f4d40c1ea4999": {
            "type": "Ybodychange",
            "commitMessage": "[pulsar-broker] Broker extensions to allow operators of enterprise wide cluster better control and flexibility (#12536)\n\n### Motivation\r\n\r\nOperators of enterprise Pulsar cluster(s) would need the flexibility and control to intercept broker events (including ledger writes/reads) for template validations, observability and access control. This changeset contains enhancements to existing interceptor mechanism to support this \r\n\r\n### Modifications\r\n\r\n- Enhanced org.apache.pulsar.broker.intercept.BrokerInterceptor interface to include additional events for tracing\r\n- Created a new interface org.apache.pulsar.common.intercept.MessagePayloadProcessor to allow interception of ledger write/read operations\r\n- Enhanced PulsarAdmin to give operators a control in managing super-users\r\n\r\n### Verifying this change\r\n\r\n- [x ] Make sure that the change passes the CI checks.\r\n\r\nThis change added tests and can be verified as follows:\r\n  - *Added new test cases to MangedLedgerInterceptorImplTest.java and BrokerInterceptorTest.java *",
            "commitDate": "14/12/21 12:49 AM",
            "commitName": "03bbc8e67ad429a774936d26ab2f4d40c1ea4999",
            "commitAuthor": "madhavan-narayanan",
            "commitDateOld": "26/11/21 7:21 PM",
            "commitNameOld": "3e3622c1d4b8b9169b4ba69081a16a539606b72d",
            "commitAuthorOld": "lipenghui",
            "daysBetweenCommits": 17.23,
            "commitsBetweenForRepo": 197,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,11 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n             ReferenceCountUtil.release(data);\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n+            if (payloadProcessorHandle != null) {\n+                payloadProcessorHandle.release();\n+            }\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            ReferenceCountUtil.release(data);\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n            if (payloadProcessorHandle != null) {\n                payloadProcessorHandle.release();\n            }\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {}
        },
        "3e3622c1d4b8b9169b4ba69081a16a539606b72d": {
            "type": "Ybodychange",
            "commitMessage": "Do not reuse the Failed OpAddEntry object. (#12993)\n\n### Motivation\r\n\r\nThere are 2 ways to complete the OpAddEntry with exception, one is the bk client callback and another one is `ManagedLedgerImple.clearPendingAddEntries`.\r\nBut, if the OpAddEntry be completed more than once, we will get NPE:\r\n\r\n```\r\njava.lang.NullPointerException: null\r\n        at org.apache.bookkeeper.mledger.impl.OpAddEntry.lambda$handleAddFailure$0(OpAddEntry.java:291) ~[org.apache.pulsar-managed-ledger-2.8.1.jar:2.8.1]\r\n        at org.apache.bookkeeper.mledger.util.SafeRun$1.safeRun(SafeRun.java:32) ~[org.apache.pulsar-managed-ledger-2.8.1.jar:2.8.1]\r\n        at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [org.apache.bookkeeper-bookkeeper-common-4.14.2-2.jar:4.14.2-2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_302]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_302]\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [io.netty-netty-common-4.1.68.Final.jar:4.1.68.Final]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_302]\r\n```\r\n\r\nAnother one:\r\n\r\n```\r\njava.lang.NullPointerException: null\r\n        at org.apache.bookkeeper.mledger.impl.OpAddEntry.addComplete(OpAddEntry.java:153) ~[org.apache.pulsar-managed-ledger-2.8.1.jar:2.8.1]\r\n        at org.apache.bookkeeper.client.AsyncCallback$AddCallback.addCompleteWithLatency(AsyncCallback.java:92) ~[org.apache.bookkeeper-bookkeeper-server-4.14.2-2.jar:4.14.2-2]\r\n        at org.apache.bookkeeper.client.PendingAddOp.submitCallback(PendingAddOp.java:431) ~[org.apache.bookkeeper-bookkeeper-server-4.14.2-2.jar:4.14.2-2]\r\n        at org.apache.bookkeeper.client.LedgerHandle.errorOutPendingAdds(LedgerHandle.java:1799) ~[org.apache.bookkeeper-bookkeeper-server-4.14.2-2.jar:4.14.2-2]\r\n        at org.apache.bookkeeper.client.LedgerHandle$5.safeRun(LedgerHandle.java:574) ~[org.apache.bookkeeper-bookkeeper-server-4.14.2-2.jar:4.14.2-2]\r\n        at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [org.apache.bookkeeper-bookkeeper-common-4.14.2-2.jar:4.14.2-2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_302]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_302]\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [io.netty-netty-common-4.1.68.Final.jar:4.1.68.Final]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_302]\r\n```\r\n#12364 tries to fix the NPE by change the state of the OpAddEntry to CLOSED, but the OpAddEntry still will be recyled and be reused.\r\nAnd when we get the add entry complete callback from the bk client, we will reach here: https://github.com/apache/pulsar/blob/5dbb7d25849f3a037aa522b5d0767801aa0a5096/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java#L147\r\n\r\nBut it might to recycle the OpAddEntry already be reused by other entry add operation. It might lead to lost data for this case.\r\n\r\n### Modification\r\n\r\nSo the fix is do not recycle the OpAddEntry when call OpAddEntry.failed() which is introduced by #11737.\r\n\r\nWe should contain this fix in 2.8.2, we have encounter serious problem when unloading the bundles, the topic close will be blocked and never complete\r\nbecause of LedgerHandle.errorOutPendingAdds() https://github.com/apache/bookkeeper/blob/87579b0a9f18833ee41fcae37582bb68606d68e7/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java#L574 get NPE but can't throw out and the ledger close callback will never complete.",
            "commitDate": "26/11/21 7:21 PM",
            "commitName": "3e3622c1d4b8b9169b4ba69081a16a539606b72d",
            "commitAuthor": "lipenghui",
            "commitDateOld": "11/11/21 3:46 AM",
            "commitNameOld": "5dbb7d25849f3a037aa522b5d0767801aa0a5096",
            "commitAuthorOld": "Yunze Xu",
            "daysBetweenCommits": 15.65,
            "commitsBetweenForRepo": 148,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,9 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n             ReferenceCountUtil.release(data);\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n-            this.recycle();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            ReferenceCountUtil.release(data);\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {}
        },
        "1bcbab04df4055714036afa3ce3bf6cf370869c9": {
            "type": "Ybodychange",
            "commitMessage": "Fix the topic in fenced state and can not recover. (#11737)\n\n* Fix the topic in fenced state and can not recover.\r\n\r\nHere is the log when the issue happens. The producer continues to reconnect to the broker, but the fenced state of the topic is always true.\r\n```\r\n19:01:42.351 [pulsar-io-4-1] INFO  org.apache.pulsar.broker.service.ServerCnx - [/10.24.34.151:48052][persistent://public/default/test-8] Creating producer. producerId=8\r\n19:01:42.352 [Thread-174681] INFO  org.apache.pulsar.broker.service.ServerCnx - [/10.24.34.151:48052] persistent://public/default/test-8 configured with schema false\r\n19:01:42.352 [Thread-174681] WARN  org.apache.pulsar.broker.service.AbstractTopic - [persistent://public/default/test-8] Attempting to add producer to a fenced topic\r\n19:01:42.352 [Thread-174681] ERROR org.apache.pulsar.broker.service.ServerCnx - [/10.24.34.151:48052] Failed to add producer to topic persistent://public/default/test-8: producerId=8, org.apache.pulsar.broker.service.BrokerServiceException$TopicFencedException: Topic is temporarily unavailable\r\n```\r\n\r\nAfter check the heap dump of the broker, the `pendingWriteOps` is 5, this is the reason why the topic can not recover from the fenced state.\r\n\r\nThe topic will change to unfenced only the `pendingWriteOps` is 0, details can find at [PersistentTopic.decrementPendingWriteOpsAndCheck()](https://github.com/apache/pulsar/blob/794aa20d9f2a4e668cc36465362d22e042e6e536/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java#L463)\r\n\r\nBut after checking the ML state of the topic, it shows the `pendingAddEntries` is 0 which not equals to `pendingWriteOps` of the topic.\r\nThe root cause is we are polling add entry op from the `pendingAddEntries` in multiple threads, one is the the ZK callback thread when complete the ledger creating (https://github.com/apache/pulsar/blob/794aa20d9f2a4e668cc36465362d22e042e6e536/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java#L1406, https://github.com/apache/pulsar/blob/794aa20d9f2a4e668cc36465362d22e042e6e536/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java#L1669),\r\nanother one is the ML worker thread when complete the add entry op (https://github.com/apache/pulsar/blob/794aa20d9f2a4e668cc36465362d22e042e6e536/managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java#L181)\r\n\r\nAfter the ongoing add entry op complete, but the corresponding op might been polled by the `clearPendingAddEntries` method. So it will poll another one, but due to\r\nnot equals to the current op, the polled op will not get a chance to be failed, so that the `pendingWriteOps` will not change to 0.\r\n\r\nI have attached the complete logs for the topic:\r\n\r\nThe fix is to complete the add entry op with ManagedLedgerException if the polled op is not equals to the current op.\r\n\r\n* Release buffer.\r\n\r\n* Revert",
            "commitDate": "24/08/21 10:27 PM",
            "commitName": "1bcbab04df4055714036afa3ce3bf6cf370869c9",
            "commitAuthor": "lipenghui",
            "commitDateOld": "28/05/21 2:25 PM",
            "commitNameOld": "0237580fde09ed39dcaae2a266ba87bbf2cfc9d4",
            "commitAuthorOld": "Lari Hotari",
            "daysBetweenCommits": 88.33,
            "commitsBetweenForRepo": 535,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,9 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n             ReferenceCountUtil.release(data);\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n+            this.recycle();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            ReferenceCountUtil.release(data);\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n            this.recycle();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "2"
        },
        "6275297499874e980b4656694f5b90aa5cc23c18": {
            "type": "Ybodychange",
            "commitMessage": "[PIP 70][Issue 8617] Introduce lightweight broker entry metadata (#8618)\n\nFixes #8617\r\n\r\n## Motivation\r\nIntroduce lightweight raw Message metadata, details can be found PIP-70\r\n\r\n## Modifications\r\nwire protocol add RawMessageMetadata and supports_raw_message_meta for FeatureFlags\r\nchange how produced message is saved in bookkeeper: add raw metadata for message\r\nchange how message is seek-by-time\r\nchange how message send back to Consumer: skip metadata if consumer not supprot raw metadata\r\nVerifying this change\r\nAdded tests for parse/skip raw message metadata\r\nAdded test for how message seek-by broker timestamp for message",
            "commitDate": "11/12/20 11:15 PM",
            "commitName": "6275297499874e980b4656694f5b90aa5cc23c18",
            "commitAuthor": "Aloys",
            "commitDateOld": "04/11/20 2:46 AM",
            "commitNameOld": "04b6468d44c8e5b511752178b81f3990f956bce0",
            "commitAuthorOld": "Rajan Dhabalia",
            "daysBetweenCommits": 37.85,
            "commitsBetweenForRepo": 251,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n-            data.release();\n+            ReferenceCountUtil.release(data);\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            ReferenceCountUtil.release(data);\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "23"
        },
        "60abcaa96508fcf9faeeeff30266ff82e9f51390": {
            "type": "Ybodychange",
            "commitMessage": "Fix bk write failure part 2 (#5322)\n\n* Bug in Message Deduplication that may cause incorrect behavior\r\n\r\n* add tests\r\n\r\n* fix error message\r\n\r\n* fix client backoff\r\n\r\n* fix tests\r\n\r\n* cleaning up\r\n\r\n* Fix handling of BK write failures for message dedup\r\n\r\n* tests and clean up\r\n\r\n* refactoring code\r\n\r\n* fixing bugs\r\n\r\n* addressing comments\r\n\r\n* add missing license header\r\n\r\n* Improve error handling of BK write failures\r\n\r\n* fixing tests\r\n\r\n* fixing bugs\r\n\r\n* cleaning up\r\n\r\n* addressing comments\r\n\r\n* fixing tests\r\n",
            "commitDate": "08/10/19 10:48 AM",
            "commitName": "60abcaa96508fcf9faeeeff30266ff82e9f51390",
            "commitAuthor": "Boyang Jerry Peng",
            "commitDateOld": "14/06/19 12:44 PM",
            "commitNameOld": "d72b986d311d8b528619f4a4dcddf757b3975dde",
            "commitAuthorOld": "Rajan Dhabalia",
            "daysBetweenCommits": 115.92,
            "commitsBetweenForRepo": 421,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n-        data.release();\n         if (cb != null) {\n+            data.release();\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            data.release();\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "1",
            "TangledWMoveandFileRename": "1"
        },
        "d72b986d311d8b528619f4a4dcddf757b3975dde": {
            "type": "Ybodychange",
            "commitMessage": "[pulsar-ml] handle race condition between timeout-task and add-call complete (#4455)\n\n* [pulsar-ml] handle race condition between timeout-task and add-call complete\r\n\r\n* rename variable with simple name\r\n",
            "commitDate": "14/06/19 12:44 PM",
            "commitName": "d72b986d311d8b528619f4a4dcddf757b3975dde",
            "commitAuthor": "Rajan Dhabalia",
            "commitDateOld": "10/02/19 7:33 AM",
            "commitNameOld": "1b44aaa78743f8dce68ffe31c25619123c9a5a5f",
            "commitAuthorOld": "Sijie Guo",
            "daysBetweenCommits": 124.17,
            "commitsBetweenForRepo": 596,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,11 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n-        if (!checkAndCompleteTimeoutTask()) {\n-            return;\n-        }\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         data.release();\n         if (cb != null) {\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        data.release();\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "6"
        },
        "a704afd1946c5648f06b12031320359d5aef623d": {
            "type": "Ybodychange",
            "commitMessage": "Support Add-entry timeout at broker to avoid stuck topics (#3347)\n\n### Motivation\r\n\r\nRecently and in past, we have seen few instances where bookie crashes when it goes out of memory and kernel panics and broker doesn't complete add-entry callback because of that topics get stuck on pending-writes.\r\n\r\n```\r\n2010-01-01T00:18:19+0000 2010-01-01 00:18:19,594 21907 report_stuck:556 WARNING persistent://prop1/global/prod-rt-mxt/extractions-partition-0 is stuck (broker1.us-west1.com): waiting for write\r\n2010-01-01T00:18:22+0000 2010-01-01 00:18:22,654 21907 report_stuck:556 WARNING persistent://prop1/global/mbr-events/27_bf1 is stuck (broker1.us-west1.com): waiting for write\r\n2010-01-01T00:19:10+0000 2010-01-01 00:19:10,790 21907 report_stuck:556 WARNING persistent://prop1/global/mbr-events/30_bf1 is stuck (broker1.us-west1.com): waiting for write\r\n2010-01-01T00:19:14+0000 2010-01-01 00:19:14,692 21907 report_stuck:556 WARNING persistent://prop1/global/mbr-events/35_gq2 is stuck (broker1.us-west1.com): waiting for write\r\n2010-01-01T00:19:15+0000 2010-01-01 00:19:15,809 21907 report_stuck:556 WARNING persistent://prop1/global/jedi-events/batchevents-partition-35 is stuck (broker1.us-west1.com): waiting for write\r\n2010-01-01T00:19:25+0000 2010-01-01 00:19:25,127 21907 report_stuck:556 WARNING persistent://prop1/global/jedi-events/mailevents-partition-24 is stuck (broker1.us-west1.com): waiting for write\r\n```\r\n\r\ninternal-stats\r\n```\r\n{\r\n  \"entriesAddedCounter\" : 66066317,\r\n  \"numberOfEntries\" : 14129359,\r\n  \"totalSize\" : 145505085493,\r\n  \"currentLedgerEntries\" : 238938,\r\n  \"currentLedgerSize\" : 3715327400,\r\n  \"lastLedgerCreatedTimestamp\" : \"2018-11-27 00:03:03.125+0000\",\r\n  \"waitingCursorsCount\" : 0,\r\n  \"pendingAddEntriesCount\" : 252514,\r\n  \"lastConfirmedEntry\" : \"489781963:26121\",\r\n  \"state\" : \"ClosingLedger\",\r\n  \"ledgers\" : [ {\r\n    \"ledgerId\" : 489765238,\r\n    \"entries\" : 559855,\r\n    \"size\" : 6928710817\r\n  }, {\r\n...\r\n```\r\n\r\n### Modifications\r\n\r\nAdd support of write timeout which can be disable by configuring timeout=0.\r\n\r\n### Result\r\n\r\ntopic will not stuck in pending write in case add-entry callback doesn't completes.\r\n",
            "commitDate": "15/01/19 9:16 AM",
            "commitName": "a704afd1946c5648f06b12031320359d5aef623d",
            "commitAuthor": "Rajan Dhabalia",
            "commitDateOld": "12/07/18 12:35 PM",
            "commitNameOld": "48431543729fc4f382637c968976d0d164d5427b",
            "commitAuthorOld": "Matteo Merli",
            "daysBetweenCommits": 186.9,
            "commitsBetweenForRepo": 876,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,11 @@\n     public void failed(ManagedLedgerException e) {\n+        if (!checkAndCompleteTimeoutTask()) {\n+            return;\n+        }\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         data.release();\n         if (cb != null) {\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        if (!checkAndCompleteTimeoutTask()) {\n            return;\n        }\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        data.release();\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "11"
        },
        "48431543729fc4f382637c968976d0d164d5427b": {
            "type": "Ybodychange",
            "commitMessage": "Fixed mem leak when receiving unrecoverable fencing errors in managed ledger (#2138)\n\n",
            "commitDate": "12/07/18 12:35 PM",
            "commitName": "48431543729fc4f382637c968976d0d164d5427b",
            "commitAuthor": "Matteo Merli",
            "commitDateOld": "03/04/18 4:48 PM",
            "commitNameOld": "d309b2cb2f766151dc64861ba15e6dc71fbe8d8f",
            "commitAuthorOld": "Matteo Merli",
            "daysBetweenCommits": 99.82,
            "commitsBetweenForRepo": 541,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,7 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n+        data.release();\n         if (cb != null) {\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        data.release();\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "1",
            "TangledWMoveandFileRename": "1"
        },
        "358bbc20f151e2fb2f321ab42dce5f68b340bfd3": {
            "type": "Ybodychange",
            "commitMessage": "Revert \"Recycle OpAddEntry when ledger-ops fails (#1415)\" (#1442)\n\nIf the OpAddEntry is recycled before the callback is triggered, the callback is calling into a dead object.\r\n\r\nThis reverts commit f5ffbbe1ed2b79be1caf4a59688eab006e932ced.",
            "commitDate": "26/03/18 4:06 PM",
            "commitName": "358bbc20f151e2fb2f321ab42dce5f68b340bfd3",
            "commitAuthor": "Ivan Kelly",
            "commitDateOld": "21/03/18 6:20 PM",
            "commitNameOld": "f5ffbbe1ed2b79be1caf4a59688eab006e932ced",
            "commitAuthorOld": "Rajan Dhabalia",
            "daysBetweenCommits": 4.91,
            "commitsBetweenForRepo": 17,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,8 +1,7 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n-            this.recycle();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "1"
        },
        "f5ffbbe1ed2b79be1caf4a59688eab006e932ced": {
            "type": "Ybodychange",
            "commitMessage": "Recycle OpAddEntry when ledger-ops fails (#1415)\n\n",
            "commitDate": "21/03/18 6:20 PM",
            "commitName": "f5ffbbe1ed2b79be1caf4a59688eab006e932ced",
            "commitAuthor": "Rajan Dhabalia",
            "commitDateOld": "12/02/18 6:16 PM",
            "commitNameOld": "a5a7c79bd43520358bd78e3a5f0cb7279f384cc8",
            "commitAuthorOld": "Dave Rusek",
            "daysBetweenCommits": 36.96,
            "commitsBetweenForRepo": 416,
            "commitsBetweenForFile": 1,
            "diff": "@@ -1,7 +1,8 @@\n     public void failed(ManagedLedgerException e) {\n         AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n         if (cb != null) {\n             cb.addFailed(e, ctx);\n             ml.mbean.recordAddEntryError();\n+            this.recycle();\n         }\n     }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n            this.recycle();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "extendedDetails": {},
            "BugCommit": "0",
            "TangledWMoveandFileRename": "1"
        },
        "9f849c324969e160f9891203b2a2e4805fae5a1c": {
            "type": "Yintroduced",
            "commitMessage": "Initial import\n",
            "commitDate": "07/09/16 12:11 AM",
            "commitName": "9f849c324969e160f9891203b2a2e4805fae5a1c",
            "commitAuthor": "Matteo Merli",
            "diff": "@@ -0,0 +1,7 @@\n+    public void failed(ManagedLedgerException e) {\n+        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n+        if (cb != null) {\n+            cb.addFailed(e, ctx);\n+            ml.mbean.recordAddEntryError();\n+        }\n+    }\n\\ No newline at end of file\n",
            "actualSource": "    public void failed(ManagedLedgerException e) {\n        AddEntryCallback cb = callbackUpdater.getAndSet(this, null);\n        if (cb != null) {\n            cb.addFailed(e, ctx);\n            ml.mbean.recordAddEntryError();\n        }\n    }",
            "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/OpAddEntry.java",
            "BugCommit": "0",
            "TangledWMoveandFileRename": "0"
        }
    },
    "file": "10571.json"
}